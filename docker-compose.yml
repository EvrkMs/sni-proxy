services:
  sni-proxy:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_TARGET: .            # или ./cmd/sni-proxy
    container_name: sni-proxy
    restart: always
    ports:
      - "443:443"
      - "80:443"
      - "8080:443"
    environment:
      - LOG_LEVEL=info
      # Если это Go-приложение: задаём предел для кучи GC (Go 1.19+ понимает GOMEMLIMIT)
      - GOMEMLIMIT=380MiB
      # Можно оставить по умолчанию, если не Go — просто не подействует.
    volumes:
      - ./dns.yaml:/dns.yaml:ro
    networks:
      - proxy-net

    # --- жёсткие и мягкие лимиты памяти ---
    mem_reservation: 128m    # «мягкий» предел — намёк Docker-у
    mem_limit: 512m          # «жёсткий» предел — выше нельзя

networks:
  proxy-net:
    driver: bridge
