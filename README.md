## How It Works: что происходит до запуска `sni-proxy`

1. **Настройка DNS на MikroTik**  
   - На уровне маршрутизатора MikroTik создаётся правило (например, с помощью DNS-static или firewall-redirect), которое перехватывает DNS-запросы клиентов к определённым доменам (например, `*.blocked-site.com`, `*.special-site.ru`) и возвращает вместо реального IP адрес прокси-сервера, на котором запущена программа `sni-proxy`.  
   - Таким образом, когда клиент в локальной сети пытается открыть “чёрный” или “фильтруемый” домен, его DNS-запрос (A/AAAA) получает IP, указывающий не на настоящий хост, а на наш прокси.

2. **Инициирование TCP/TLS-соединения клиентом**  
   - Клиентское приложение (браузер, мобильное приложение и т. д.) получает IP прокси и запускает TCP-пакет (событие TCP SYN) на порт 443 (HTTPS) или 80 (HTTP), но фактически соединяется с сервером `sni-proxy`.  
   - Поскольку клиент считает, что это тот самый сайт, он формирует свой TLS ClientHello так, как будто он соединяется с оригинальным сервером (включая SNI-поле, в котором указан желаемый домен).

3. **Парсинг SNI (или Host)**  
   - `sni-proxy` на своём сетевом интерфейсе принимает входящее TCP/TLS-соединение.  
   - **Если это HTTPS**: первые данные от клиента содержат TLS ClientHello. Внутри этого пакета есть поле SNI (Server Name Indication), где явно указано имя целевого домена (например, `example.com`).  


4. **Установка второго соединения к реальному серверу**  
   - Узнав “правильное” имя хоста (из SNI или Host), программа устанавливает исходящее соединение (outgoing socket) к реальному IP-адресу этого хоста (либо делает DNS-запрос к внешнему DNS, чтобы узнать его A/AAAA).  
   - После установки соединения с реальным сервером `sni-proxy` начинает передавать (форвардить) потоки данных “клиент ↔ реальный сервер” почти в режиме “байт в байт” (raw TCP relay).

5. **Проксирование трафика**  
   - Всё, что пришло от клиента, пересылается в поток к реальному серверу, а ответы от реального сервера идут обратно клиенту через `sni-proxy`.  
   - В итоге клиент и реальный сервер обмениваются данными через прокси, но при этом сами они “не подозревают” о вмешательстве: с точки зрения клиента, он всё ещё “соединён” с `example.com`, а реальный сервер думает, что соединяется с клиентом напрямую.

### Зачем это нужно
- **Фильтрация или перенаправление трафика**: с помощью MikroTik мы определили, что такие-то домены должны идти через прокси. Это может быть полезно для логирования, ограничения доступа, внедрения дополнительных политик или для скрытия реального IP-адреса клиентов.  
- **Минимальные требования к прокси**: программа не хранит жёстко список доменов — она просто парсит SNI/Host и перенаправляет поток. Логика фильтрации (каким доменам выдавать “IP прокси” на уровне DNS) полностью вынесена в настройку маршрутизатора.

